name: Deploy Telivra to VPS

on:
  push:
    branches:
      - 'claude/analyze-project-8IHsf'
    paths:
      - '.github/workflows/deploy-vps.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Find SSH port
        id: ssh
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq sshpass
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=20"
          for PORT in 2215 2220 22; do
            echo "Trying port $PORT..."
            if sshpass -p 'GynecoTerrano2026' ssh $SSH_OPTS -p $PORT root@161.35.110.36 "echo OK" 2>/dev/null; then
              echo "port=$PORT" >> $GITHUB_OUTPUT
              echo "host=161.35.110.36" >> $GITHUB_OUTPUT
              echo "Connected on port $PORT"
              exit 0
            fi
          done
          echo "Trying Cloudflare tunnel..."
          if sshpass -p 'GynecoTerrano2026' ssh $SSH_OPTS root@gyneco.terrano-hosting.com "echo OK" 2>/dev/null; then
            echo "port=22" >> $GITHUB_OUTPUT
            echo "host=gyneco.terrano-hosting.com" >> $GITHUB_OUTPUT
            echo "Connected via Cloudflare"
            exit 0
          fi
          echo "Cannot connect to VPS"
          exit 1

      - name: Install PostgreSQL on VPS
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh.outputs.host }}
          username: root
          password: GynecoTerrano2026
          port: ${{ steps.ssh.outputs.port }}
          command_timeout: 10m
          script: |
            echo "=== Installing PostgreSQL ==="
            if command -v psql &>/dev/null; then
              echo "PostgreSQL already installed: $(psql --version)"
            else
              apt-get update -qq
              apt-get install -y -qq postgresql postgresql-contrib
            fi
            systemctl start postgresql 2>/dev/null || service postgresql start 2>/dev/null || true
            systemctl enable postgresql 2>/dev/null || true
            sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='telivra'" | grep -q 1 || sudo -u postgres psql -c "CREATE USER telivra WITH PASSWORD 'TelivraSecure2026!';"
            sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='telivra'" | grep -q 1 || sudo -u postgres psql -c "CREATE DATABASE telivra OWNER telivra;"
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE telivra TO telivra;" 2>/dev/null || true
            echo "PostgreSQL ready!"

      - name: Clone repo and create .env
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh.outputs.host }}
          username: root
          password: GynecoTerrano2026
          port: ${{ steps.ssh.outputs.port }}
          command_timeout: 5m
          script: |
            REPO_URL="https://github.com/Terranoweb2/telivra.git"
            APP_DIR="/root/t-delivery"
            if [ -d "$APP_DIR/.git" ]; then
              echo "Repo exists, updating..."
              cd "$APP_DIR"
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repo..."
              rm -rf "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
            fi
            cd "$APP_DIR"
            echo 'DATABASE_URL="postgresql://telivra:TelivraSecure2026!@localhost:5432/telivra"' > .env
            echo 'NEXTAUTH_SECRET="zJZz9xnZkzi6S+Q65PJGD1YiswWOzwaihxVxyOGtVhg="' >> .env
            echo 'NEXTAUTH_URL="https://t-delivery.com"' >> .env
            echo 'NODE_ENV="production"' >> .env
            echo 'PORT=3001' >> .env
            echo "=== .env created ==="
            cat .env

      - name: Install Node.js and dependencies
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh.outputs.host }}
          username: root
          password: GynecoTerrano2026
          port: ${{ steps.ssh.outputs.port }}
          command_timeout: 10m
          script: |
            if command -v node &>/dev/null; then
              NODE_MAJOR=$(node -v | cut -d. -f1 | tr -d 'v')
              echo "Node.js $(node -v) detected"
              if [ "$NODE_MAJOR" -lt 18 ]; then
                echo "Upgrading Node.js..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
                apt-get install -y -qq nodejs
              fi
            else
              echo "Installing Node.js 20..."
              apt-get update -qq
              apt-get install -y -qq curl build-essential
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y -qq nodejs
            fi
            echo "Node: $(node -v) / npm: $(npm -v)"
            command -v pm2 &>/dev/null || npm install -g pm2
            npm list -g tsx &>/dev/null 2>&1 || npm install -g tsx
            pm2 startup systemd -u root --hp /root 2>/dev/null || true
            cd /root/t-delivery
            npm ci --production=false 2>/dev/null || npm install
            echo "Dependencies installed!"

      - name: Prisma and database setup
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh.outputs.host }}
          username: root
          password: GynecoTerrano2026
          port: ${{ steps.ssh.outputs.port }}
          command_timeout: 5m
          script: |
            cd /root/t-delivery
            npx prisma generate
            npx prisma db push --accept-data-loss 2>/dev/null || npx prisma migrate deploy 2>/dev/null || echo "DB sync done"
            if [ ! -f ".seed_done" ]; then
              npx tsx prisma/seed.ts 2>/dev/null && touch .seed_done && echo "Seed done!" || echo "Seed skipped"
            fi
            mkdir -p public/uploads
            chmod 755 public/uploads
            echo "Prisma setup complete!"

      - name: Build Next.js
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh.outputs.host }}
          username: root
          password: GynecoTerrano2026
          port: ${{ steps.ssh.outputs.port }}
          command_timeout: 15m
          script: |
            cd /root/t-delivery
            NODE_ENV=production npm run build
            echo "Build complete!"

      - name: Start PM2 and configure Nginx
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ steps.ssh.outputs.host }}
          username: root
          password: GynecoTerrano2026
          port: ${{ steps.ssh.outputs.port }}
          command_timeout: 5m
          script: |
            cd /root/t-delivery
            pm2 delete t-delivery 2>/dev/null || true
            pm2 start node_modules/.bin/tsx --name t-delivery -- server.ts
            pm2 save
            sleep 3
            pm2 show t-delivery | grep status || true
            pm2 list
            cp -r /etc/nginx/sites-enabled /etc/nginx/sites-enabled.bak.$(date +%Y%m%d) 2>/dev/null || true
            cp deploy/nginx-t-delivery.conf /etc/nginx/sites-available/t-delivery.conf
            ln -sf /etc/nginx/sites-available/t-delivery.conf /etc/nginx/sites-enabled/t-delivery.conf
            nginx -t && systemctl reload nginx
            ufw allow 80/tcp 2>/dev/null || true
            ufw allow 443/tcp 2>/dev/null || true
            ufw allow 22/tcp 2>/dev/null || true
            ufw allow 2215/tcp 2>/dev/null || true
            echo ""
            echo "============================================"
            echo "  TELIVRA DEPLOYED SUCCESSFULLY!"
            echo "  URL: https://t-delivery.com"
            echo "  Port: 3001"
            echo "  PM2: t-delivery"
            echo "============================================"
