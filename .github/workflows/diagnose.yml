name: VPS Diagnostics

on:
  push:
    branches:
      - 'claude/analyze-project-8IHsf'
    paths:
      - '.github/workflows/diagnose.yml'
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Install sshpass
        run: sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Find SSH port
        id: ssh
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=20"
          for PORT in 2215 2220 22; do
            if sshpass -p 'GynecoTerrano2026' ssh $SSH_OPTS -p $PORT root@161.35.110.36 "echo OK" 2>/dev/null; then
              echo "port=$PORT" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          exit 1

      - name: Full VPS Diagnostics
        uses: appleboy/ssh-action@v1
        with:
          host: 161.35.110.36
          username: root
          password: GynecoTerrano2026
          port: ${{ steps.ssh.outputs.port }}
          command_timeout: 3m
          script: |
            echo "========================================"
            echo "  VPS FULL DIAGNOSTICS"
            echo "========================================"

            echo ""
            echo "=== 1. ALL NGINX CONFIGS ==="
            echo "--- sites-enabled ---"
            ls -la /etc/nginx/sites-enabled/ 2>/dev/null || echo "No sites-enabled"
            echo ""
            echo "--- Each config content ---"
            for f in /etc/nginx/sites-enabled/*; do
              echo ">>> FILE: $f <<<"
              cat "$f" 2>/dev/null
              echo ""
              echo "---"
            done
            echo ""
            echo "--- conf.d ---"
            ls -la /etc/nginx/conf.d/ 2>/dev/null || echo "No conf.d"
            for f in /etc/nginx/conf.d/*.conf; do
              echo ">>> FILE: $f <<<"
              cat "$f" 2>/dev/null
              echo ""
            done

            echo ""
            echo "=== 2. NGINX MAIN CONFIG (server blocks) ==="
            grep -n 'server_name\|listen\|proxy_pass\|default_server' /etc/nginx/nginx.conf 2>/dev/null || echo "No matches"

            echo ""
            echo "=== 3. PM2 STATUS ==="
            pm2 list 2>/dev/null || echo "PM2 not running"

            echo ""
            echo "=== 4. PM2 LOGS (t-delivery) ==="
            pm2 logs t-delivery --lines 40 --nostream 2>/dev/null || echo "No t-delivery app"

            echo ""
            echo "=== 5. PORT CHECK ==="
            ss -tlnp 2>/dev/null | head -20 || netstat -tlnp 2>/dev/null | head -20

            echo ""
            echo "=== 6. DIRECT APP TEST ==="
            echo "Port 3001:"
            curl -s -o /dev/null -w "  HTTP %{http_code}\n" http://localhost:3001/ 2>/dev/null || echo "  Not responding"
            echo "Port 3001 content (first 200 chars):"
            curl -s http://localhost:3001/ 2>/dev/null | head -c 200 || echo "  No content"
            echo ""
            echo "Port 3000:"
            curl -s -o /dev/null -w "  HTTP %{http_code}\n" http://localhost:3000/ 2>/dev/null || echo "  Not responding"

            echo ""
            echo "=== 7. NGINX HOST ROUTING TEST ==="
            echo "Host: t-delivery.com -> port 80:"
            curl -s -H "Host: t-delivery.com" -o /dev/null -w "  HTTP %{http_code}\n" http://localhost:80/ 2>/dev/null || echo "  Not responding"
            echo "Content:"
            curl -s -H "Host: t-delivery.com" http://localhost:80/ 2>/dev/null | head -c 200 || echo "  No content"
            echo ""
            echo "Host: gyneco -> port 80:"
            curl -s -o /dev/null -w "  HTTP %{http_code}\n" http://localhost:80/ 2>/dev/null || echo "  Not responding"

            echo ""
            echo "=== 8. APP DIRECTORY CHECK ==="
            echo "--- /root/t-delivery ---"
            ls -la /root/t-delivery/.next/ 2>/dev/null | head -5 || echo "No .next"
            echo ""
            echo "--- .env exists? ---"
            ls -la /root/t-delivery/.env 2>/dev/null || echo "No .env"
            echo ""
            echo "--- ecosystem.config.js ---"
            cat /root/t-delivery/ecosystem.config.js 2>/dev/null || echo "No ecosystem config"

            echo ""
            echo "=== 9. CLOUDFLARED STATUS ==="
            systemctl status cloudflared --no-pager 2>/dev/null || echo "Not running"

            echo ""
            echo "=== 10. PROCESS LIST ==="
            ps aux | grep -E 'next|node|nginx|cloudflared' | grep -v grep || echo "No relevant processes"

            echo ""
            echo "========================================"
            echo "  DIAGNOSTICS COMPLETE"
            echo "========================================"
